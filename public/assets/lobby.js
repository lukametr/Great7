window.i18n = {
  ka: {
    homeTitle: "áƒšáƒáƒ‘áƒ˜",
    homeDesc: "áƒ˜áƒ—áƒáƒ›áƒáƒ¨áƒ”áƒ— áƒ›áƒ”áƒ’áƒáƒ‘áƒ áƒ”áƒ‘áƒ—áƒáƒœ áƒáƒœ áƒ¨áƒ”áƒ¥áƒ›áƒ”áƒœáƒ˜áƒ— áƒáƒ®áƒáƒšáƒ˜ áƒáƒ—áƒáƒ®áƒ˜!",
    login: "áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ",
    register: "áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ",
    email: "áƒ”áƒšáƒ¤áƒáƒ¡áƒ¢áƒ",
    password: "áƒáƒáƒ áƒáƒšáƒ˜",
    name: "áƒ¡áƒáƒ®áƒ”áƒšáƒ˜",
    repeatPassword: "áƒ’áƒáƒ˜áƒ›áƒ”áƒáƒ áƒ”áƒ— áƒáƒáƒ áƒáƒšáƒ˜",
    submit: "áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ",
    toRegister: "áƒáƒ  áƒ’áƒáƒ¥áƒ•áƒ— áƒáƒœáƒ’áƒáƒ áƒ˜áƒ¨áƒ˜? áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ",
    toLogin: "áƒ£áƒ™áƒ•áƒ” áƒ’áƒáƒ¥áƒ•áƒ— áƒáƒœáƒ’áƒáƒ áƒ˜áƒ¨áƒ˜? áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ",
    lobby: "áƒšáƒáƒ‘áƒ˜",
    logout: "áƒ’áƒáƒ›áƒáƒ¡áƒ•áƒšáƒ",
    createRoom: "áƒáƒ—áƒáƒ®áƒ˜áƒ¡ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ",
    roomName: "áƒáƒ—áƒáƒ®áƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜",
    join: "áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ",
    stats: "áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ",
    rooms: "áƒáƒ—áƒáƒ®áƒ”áƒ‘áƒ˜",
    error: "áƒ“áƒáƒ¤áƒ˜áƒ¥áƒ¡áƒ˜áƒ áƒ“áƒ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ",
    userStats: "áƒ›áƒáƒ—áƒáƒ›áƒáƒ¨áƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ",
    profile: "áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜",
    emailExists: "áƒ”áƒ¡ áƒ”áƒšáƒ¤áƒáƒ¡áƒ¢áƒ áƒ£áƒ™áƒ•áƒ” áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ",
    loginIncorrect: "áƒ”áƒšáƒ¤áƒáƒ¡áƒ¢áƒ áƒáƒœ áƒáƒáƒ áƒáƒšáƒ˜ áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜áƒ"
  },
  en: {
    homeTitle: "lobby",
    homeDesc: "play with friends or create a new room!",
    login: "Login",
    register: "Register",
    email: "Email",
    password: "Password",
    name: "Name",
    repeatPassword: "Repeat password",
    submit: "Submit",
    toRegister: "Don't have an account? Register",
    toLogin: "Already have an account? Login",
    lobby: "Lobby",
    logout: "Logout",
    createRoom: "Create Room",
    roomName: "Room name",
    join: "Join",
    stats: "Stats",
    rooms: "Rooms",
    error: "An error occurred",
    userStats: "Player stats",
    profile: "Profile",
    emailExists: "Email already registered",
    loginIncorrect: "Email or password is incorrect"
  },
  ru: {
    homeTitle: "115-star lobby",
    homeDesc: "Enter the lobby, play with friends or create a new room!",
    login: "Login",
    register: "Register",
    email: "Email",
    password: "Password",
    name: "Name",
    repeatPassword: "Repeat password",
    submit: "Submit",
    toRegister: "Don't have an account? Register",
    toLogin: "Already have an account? Login",
    lobby: "Lobby",
    logout: "Logout",
    createRoom: "Create Room",
    roomName: "Room name",
    join: "Join",
    stats: "Stats",
    rooms: "Rooms",
    error: "An error occurred",
    userStats: "Player stats",
    profile: "Profile",
    emailExists: "Email already registered",
    loginIncorrect: "Email or password is incorrect"
  }
};
const i18n = window.i18n;
let lang = localStorage.getItem('lang') || 'ka';
function t(key) { return i18n[lang][key] || key; }
function setLang(newLang) {
  if (newLang === 'ru') {
    showRussianPopup();
    return;
  }
  lang = newLang;
  window.lang = lang;
  localStorage.setItem('lang', lang);
  // Update home page button texts if present
  if (document.getElementById('login-btn')) document.getElementById('login-btn').textContent = t('login');
  if (document.getElementById('register-btn')) document.getElementById('register-btn').textContent = t('register');
  // If in lobby, re-render lobby, else re-render home
  const lobbySection = document.getElementById('lobby-section');
  if (lobbySection && lobbySection.style.display === 'block') {
    renderLobby(true);
  } else {
    renderHome();
  }
}

// SPA routing
function showSection(id) {
  ['home-section','login-section','register-section','lobby-section'].forEach(s => {
    const el = document.getElementById(s);
    if (el) el.style.display = (s===id)?'block':'none';
  });
}

window.addEventListener('DOMContentLoaded', function() {
  const loginBtn = document.getElementById('login-btn');
  if (loginBtn) loginBtn.onclick = () => renderLogin();

  const registerBtn = document.getElementById('register-btn');
  if (registerBtn) registerBtn.onclick = () => renderRegister();
});

function renderHome() {
  showSection('home-section');
  if (!document.getElementById('lang-switch-wrap')) {
    const header = document.querySelector('header');
    const wrap = document.createElement('div');
    wrap.id = 'lang-switch-wrap';
    wrap.style.float = 'right';
    header.appendChild(wrap);
  }
  renderLangDropdown('lang-switch-wrap', lang, setLang);
  if (document.getElementById('home-title')) document.getElementById('home-title').textContent = t('homeTitle');
  if (document.getElementById('home-desc')) document.getElementById('home-desc').textContent = t('homeDesc');
  if (document.getElementById('login-btn')) document.getElementById('login-btn').textContent = t('login');
  if (document.getElementById('register-btn')) document.getElementById('register-btn').textContent = t('register');
}

function renderLogin(errorMsg) {
  showSection('login-section');
  const el = document.getElementById('login-section');
  el.innerHTML = `<div class="form-box">
    <div class="form-title">${t('login')}</div>
    ${errorMsg?`<div class="form-error">${errorMsg}</div>`:''}
    <form id="login-form">
      <div class="form-group">
        <label class="form-label">${t('email')}</label>
        <input class="form-input" type="email" name="email" required />
      </div>
      <div class="form-group">
        <label class="form-label">${t('password')}</label>
        <input class="form-input" type="password" name="password" required />
      </div>
      <button class="form-btn" type="submit">${t('login')}</button>
    </form>
    <div style="margin-top:10px;text-align:center"><a href="#" id="to-register">${t('toRegister')}</a></div>
  </div>`;
  document.getElementById('to-register').onclick = (e) => { e.preventDefault(); renderRegister(); };
  document.getElementById('login-form').onsubmit = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: fd.get('email'), password: fd.get('password') })
    });
    if (res.ok) {
      const data = await res.json();
      localStorage.setItem('token', data.token);
      renderLobby();
    } else if (res.status === 401) {
      renderLogin(t('loginIncorrect'));
    } else {
      renderLogin(t('error'));
    }
  };
}

function renderRegister(errorMsg) {
  showSection('register-section');
  const el = document.getElementById('register-section');
  el.innerHTML = `<div class="form-box">
    <div class="form-title">${t('register')}</div>
    ${errorMsg?`<div class="form-error">${errorMsg}</div>`:''}
    <form id="register-form">
      <div class="form-group">
        <label class="form-label">${t('name')}</label>
        <input class="form-input" type="text" name="name" required />
      </div>
      <div class="form-group">
        <label class="form-label">${t('email')}</label>
        <input class="form-input" type="email" name="email" required />
      </div>
      <div class="form-group">
        <label class="form-label">${t('password')}</label>
        <input class="form-input" type="password" name="password" required />
      </div>
      <div class="form-group">
        <label class="form-label">${t('repeatPassword')}</label>
        <input class="form-input" type="password" name="repeatPassword" required />
      </div>
      <button class="form-btn" type="submit">${t('register')}</button>
    </form>
    <div style="margin-top:10px;text-align:center"><a href="#" id="to-login">${t('toLogin')}</a></div>
  </div>`;
  document.getElementById('to-login').onclick = (e) => { e.preventDefault(); renderLogin(); };
  document.getElementById('register-form').onsubmit = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    if (fd.get('password') !== fd.get('repeatPassword')) {
      renderRegister(t('error'));
      return;
    }
    const res = await fetch('/api/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: fd.get('name'), email: fd.get('email'), password: fd.get('password') })
    });
    if (res.ok) {
      renderLogin();
    } else if (res.status === 409) {
      renderRegister(t('emailExists'));
    } else {
      renderRegister(t('error'));
    }
  };
}

let lobbyRoomsInterval = null;

async function fetchAndRenderRooms(el, user) {
  const token = localStorage.getItem('token');
  const resRooms = await fetch('/api/rooms', { headers: { 'Authorization': 'Bearer '+token } });
  const rooms = await resRooms.json();
  const roomsHtml = rooms.map(room => {
    // Compose joined count text (e.g. "4/3")
    const joinedText = `${room.players}/${room.joined}`;
    return `
      <div class="lobby-room">
        <div style="display:flex;flex-direction:column;gap:2px;">
          <span class="lobby-room-title">${room.name}</span>
          <span style="font-size:0.93em;color:#fff;background:#23272f;border-radius:6px;padding:2px 8px;display:inline-block;width:max-content;margin-top:2px;">${joinedText}</span>
        </div>
        <button class="lobby-room-join" data-id="${room.id}">${t('join')}</button>
      </div>
    `;
  }).join('');
  el.querySelector('.lobby-rooms').innerHTML = `<h3>${t('rooms')}</h3>${roomsHtml}`;
  el.querySelectorAll('.lobby-room-join').forEach(btn => {
    btn.onclick = () => {
      window.location.href = `great7.html?room=${btn.dataset.id}`;
    };
  });
}

async function renderLobby(keepUser) {
  showSection('lobby-section');
  const el = document.getElementById('lobby-section');
  if (!el) return;
  const token = localStorage.getItem('token');
  if (!token) { renderLogin(); return; }
  let user = null;
  if (keepUser && window._lastLobbyUser) {
    user = window._lastLobbyUser;
  } else {
    try {
      const resUser = await fetch('/api/me', { headers: { 'Authorization': 'Bearer '+token } });
      user = await resUser.json();
      window._lastLobbyUser = user;
      console.log('LOBBY USER:', user);
    } catch (e) {
      renderLogin();
      return;
    }
  }
  el.innerHTML = `
    <div class="lobby-header" role="navigation">
      <span class="lobby-user">${user.name} (${user.email})</span>
      <button class="main-btn" id="rules-btn" aria-label="áƒ—áƒáƒ›áƒáƒ¨áƒ˜áƒ¡ áƒ¬áƒ”áƒ¡áƒ”áƒ‘áƒ˜" tabindex="0">áƒ—áƒáƒ›áƒáƒ¨áƒ˜áƒ¡ áƒ¬áƒ”áƒ¡áƒ”áƒ‘áƒ˜</button>
      <button class="main-btn" id="profile-btn" aria-label="áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜" tabindex="0">${t('profile')}</button>
    </div>
    <div class="lobby-stats" style="margin-bottom:12px;">
      <b>${t('stats')||'áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ'}:</b>
      ${user.wins !== undefined ? `
        <div style="margin-top:4px;">${t('wins')||'áƒ›áƒáƒ’áƒ”áƒ‘áƒ'}: ${user.wins}</div>
        <div>${t('losses')||'áƒ¬áƒáƒ’áƒ”áƒ‘áƒ'}: ${user.losses}</div>
        <div>${t('gamesPlayed')||'áƒ—áƒáƒ›áƒáƒ¨áƒ”áƒ‘áƒ˜'}: ${user.gamesPlayed}</div>
        <div>Level: ${user.level} <span style="font-size:0.95em;color:#fff;">(XP: ${user.xp})</span></div>
      ` : '-'}
    </div>
    <div class="lobby-rooms"></div>
    <div class="lobby-create">
      <button class="lobby-create-btn" id="create-room-btn">${t('createRoom')}</button>
    </div>
    <div id="modal-bg" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000a;z-index:1000;justify-content:center;align-items:center;">
      <div id="modal-box" style="background:#23272f;padding:24px 20px;border-radius:12px;min-width:260px;max-width:90vw;box-shadow:0 2px 16px #0008;"></div>
    </div>
    <div class="lobby-logout-wrap" style="margin-top:32px;display:flex;justify-content:center;">
      <button class="main-btn" id="logout-btn" aria-label="áƒ’áƒáƒ›áƒáƒ¡áƒ•áƒšáƒ" tabindex="0" style="min-width:160px;">${t('logout')}</button>
    </div>
    <span style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">áƒœáƒáƒ•áƒ˜áƒ’áƒáƒªáƒ˜áƒ: áƒáƒ áƒáƒ¤áƒ˜áƒšáƒ˜ áƒ“áƒ áƒ’áƒáƒ›áƒáƒ¡áƒ•áƒšáƒ˜áƒ¡ áƒ¦áƒ˜áƒšáƒáƒ™áƒ”áƒ‘áƒ˜ áƒ®áƒ”áƒšáƒ›áƒ˜áƒ¡áƒáƒ¬áƒ•áƒ“áƒáƒ›áƒ˜áƒ áƒ™áƒšáƒáƒ•áƒ˜áƒáƒ¢áƒ£áƒ áƒ˜áƒ— áƒ“áƒ áƒ”áƒ™áƒ áƒáƒœáƒ˜áƒ¡ áƒ›áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ”áƒšáƒ˜áƒ—</span>
  `;
  renderLangDropdown('lang-switch-wrap', lang, setLang);
  document.getElementById('rules-btn').onclick = function() {
    let modal = document.getElementById('rules-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'rules-modal';
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.32)';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = '3000';
      const lang = (JSON.parse(localStorage.getItem('great7-lobby'))?.lang)||'ka';
      modal.innerHTML = `
        <div style=\"background:#fff;color:#222;padding:32px 28px 24px 28px;border-radius:16px;box-shadow:0 2px 24px #0008;min-width:260px;max-width:90vw;text-align:left;max-height:90vh;overflow-y:auto;\">
          <div style=\"font-size:1.3em;font-weight:bold;margin-bottom:12px;text-align:center;\">áƒ—áƒáƒ›áƒáƒ¨áƒ˜áƒ¡ áƒ¬áƒ”áƒ¡áƒ”áƒ‘áƒ˜</div>
          <div id=\"rules-ka\" style=\"font-size:1.05em;line-height:1.6;display:${lang==='ka'?'':'none'};\">
            <b>Great 7 </b> áƒáƒ áƒ˜áƒ¡ 2-6 áƒ›áƒáƒ—áƒáƒ›áƒáƒ¨áƒ”áƒ–áƒ” áƒ’áƒáƒ—áƒ•áƒšáƒ˜áƒšáƒ˜ áƒ¡áƒ¢áƒ áƒáƒ¢áƒ”áƒ’áƒ˜áƒ£áƒšáƒ˜ áƒ—áƒáƒ›áƒáƒ¨áƒ˜. <br><br>
            <b>áƒ›áƒ˜áƒ–áƒáƒœáƒ˜:</b>áƒ—áƒáƒ›áƒáƒ¨áƒ˜áƒ¡ áƒ›áƒáƒ¡áƒáƒ’áƒ”áƒ‘áƒáƒ“ áƒ’áƒáƒ“áƒáƒ˜áƒ§áƒ•áƒáƒœáƒ” áƒ¨áƒ”áƒœáƒ˜ áƒ§áƒ•áƒ”áƒšáƒ áƒ¥áƒ•áƒ áƒ¡áƒáƒáƒ˜áƒ áƒ˜áƒ¡áƒáƒ˜áƒ áƒ áƒ™áƒ£áƒ—áƒ®áƒ”áƒ¨áƒ˜ áƒ›áƒ“áƒ”áƒ‘áƒáƒ áƒ” áƒ áƒ’áƒáƒšáƒ¨áƒ˜.<br><br>
            <b>áƒ¡áƒ•áƒšáƒ”áƒ‘áƒ˜:</b> áƒ—áƒ˜áƒ—áƒáƒ”áƒ£áƒš áƒ¡áƒ•áƒšáƒáƒ–áƒ” áƒ¨áƒ”áƒ’áƒ˜áƒ«áƒšáƒ˜áƒ áƒ’áƒáƒ“áƒáƒáƒ“áƒ’áƒ˜áƒšáƒ áƒ”áƒ áƒ—áƒ˜ áƒ¥áƒ•áƒ áƒ›áƒ”áƒ–áƒáƒ‘áƒ”áƒš áƒªáƒáƒ áƒ˜áƒ”áƒš áƒ‘áƒ£áƒ“áƒ”áƒ¨áƒ˜ áƒáƒœ áƒ’áƒáƒ“áƒáƒ®áƒ¢áƒ” áƒ¡áƒ®áƒ•áƒ áƒ¥áƒ•áƒáƒ–áƒ” (áƒáƒœ áƒ áƒ˜áƒ’-áƒ áƒ˜áƒ’áƒáƒ‘áƒ˜áƒ— áƒ áƒáƒ›áƒ“áƒ”áƒœáƒ˜áƒ›áƒ” áƒ’áƒáƒ“áƒáƒ®áƒ¢áƒáƒ›áƒ).<br><br>
            <b>áƒ’áƒáƒ“áƒáƒ®áƒ¢áƒáƒ›áƒ:</b> áƒ¥áƒ•áƒ áƒ¨áƒ”áƒ˜áƒ«áƒšáƒ”áƒ‘áƒ áƒ’áƒáƒ“áƒáƒ®áƒ¢áƒ”áƒ¡ áƒ›áƒ”áƒ–áƒáƒ‘áƒ”áƒš áƒ¥áƒ•áƒáƒ–áƒ” áƒ“áƒ áƒ“áƒáƒ”áƒ¨áƒ•áƒáƒ¡ áƒ›áƒ˜áƒ¡ áƒ˜áƒ¥áƒ˜áƒ— áƒáƒ áƒ¡áƒ”áƒ‘áƒ£áƒš áƒªáƒáƒ áƒ˜áƒ”áƒš áƒ‘áƒ£áƒ“áƒ”áƒ¨áƒ˜. áƒ¨áƒ”áƒ¡áƒáƒ«áƒšáƒ”áƒ‘áƒ”áƒšáƒ˜áƒ áƒ áƒáƒ›áƒ“áƒ”áƒœáƒ˜áƒ›áƒ” áƒ’áƒáƒ“áƒáƒ‘áƒ›áƒ£áƒšáƒ˜ áƒ’áƒáƒ“áƒáƒ®áƒ¢áƒáƒ›áƒ.<br><br>
            <b>áƒ¡áƒ•áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ:</b> áƒ—áƒ£ áƒ¨áƒ”áƒ’áƒ˜áƒ«áƒšáƒ˜áƒ áƒ’áƒáƒ“áƒáƒ®áƒ¢áƒáƒ›áƒ, áƒ¨áƒ”áƒ’áƒ˜áƒ«áƒšáƒ˜áƒ áƒ’áƒáƒáƒ’áƒ áƒ«áƒ”áƒšáƒ áƒáƒœ áƒ“áƒáƒáƒ¡áƒ áƒ£áƒšáƒ áƒ¡áƒ•áƒšáƒ áƒœáƒ”áƒ‘áƒ˜áƒ¡áƒ›áƒ˜áƒ”áƒ  áƒ“áƒ áƒáƒ¡.<br><br>
            <b>áƒ“áƒ áƒ:</b> áƒ—áƒ˜áƒ—áƒáƒ”áƒ£áƒš áƒ›áƒáƒ—áƒáƒ›áƒáƒ¨áƒ”áƒ¡ áƒáƒ¥áƒ•áƒ¡ áƒ¨áƒ”áƒ–áƒ¦áƒ£áƒ“áƒ£áƒšáƒ˜ áƒ“áƒ áƒ áƒ¡áƒ•áƒšáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡.<br><br>
            <b>áƒ›áƒáƒ’áƒ”áƒ‘áƒ:</b> áƒ•áƒ˜áƒœáƒª áƒáƒ˜áƒ áƒ•áƒ”áƒšáƒ˜ áƒ’áƒáƒ“áƒáƒ˜áƒ§áƒ•áƒáƒœáƒ¡ áƒ§áƒ•áƒ”áƒšáƒ áƒ—áƒáƒ•áƒ˜áƒ¡ áƒ¥áƒ•áƒáƒ¡ áƒ›áƒ˜áƒ–áƒœáƒ˜áƒ¡ áƒ–áƒáƒœáƒáƒ¨áƒ˜, áƒ˜áƒ¡ áƒ˜áƒ’áƒ”áƒ‘áƒ¡.<br><br>
          </div>
          <div id=\"rules-en\" style=\"font-size:1.05em;line-height:1.6;display:${lang==='en'?'':'none'};\">
            <b>Overview of \"Great 7\" Board Game</b><br><br>
            <b>Game Concept</b><br>
            \"Great 7\" is a unique, high-strategy board game designed for 2â€“6 players.<br><br>
            <b>Objective</b><br>
            The first player to transfer all seven of their stones into the opponent's starting \"ring\" (goal zone) wins the game.<br><br>
            <b>Setup</b><br>
            The board is an NxN grid laid out as a strategic labyrinth.<br>
            Each player places their seven stones on designated starting positions.<br><br>
            <b>Types of Moves</b><br>
            <u>Adjacent Move</u><br>
            Move one stone into an adjacent empty square.<br><br>
            <u>Jump Move</u><br>
            A stone may jump over another stone in a chosen direction.<br>
            If the stone to be jumped is K squares away, the jumping stone lands K+1 squares beyond it (leveraging advanced corporate-level strategy).<br>
            Multiple consecutive jumps are allowed in a single turn, at the player's discretion.<br><br>
            <b>Ending a Turn</b><br>
            A turn may be ended at any time after at least one adjacent move or jump has been executed.<br><br>
            <b>Time Constraint</b><br>
            Each player has a time limit per move (Move Timer) to maintain game flow and uphold optimal strategic planning.<br><br>
            <b>Winning the Game</b><br>
            The first player to transfer all seven stones into the opponent's ring zone is declared the winner.<br>
          </div>
          <div style=\"text-align:center;margin-top:18px;\">
            <button id=\"close-rules-modal\" style=\"background:#e74c3c;color:#fff;padding:8px 22px;font-size:1.1em;border:none;border-radius:7px;cursor:pointer;\">áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('close-rules-modal').onclick = function() {
        modal.remove();
      };
      modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
    }
  };
  document.getElementById('profile-btn').onclick = () => {
    window.location.href = '/profile.html';
  };
  document.getElementById('logout-btn').onclick = () => { 
    localStorage.removeItem('token'); 
    localStorage.removeItem('great7-lobby');
    if (lobbyRoomsInterval) clearInterval(lobbyRoomsInterval);
    renderHome(); 
  };
  document.getElementById('create-room-btn').onclick = () => showCreateRoomModal();
  fetchAndRenderRooms(el, user);
  if (lobbyRoomsInterval) clearInterval(lobbyRoomsInterval);
  lobbyRoomsInterval = setInterval(() => fetchAndRenderRooms(el, user), 2000);
}

function showCreateRoomModal() {
  const modalBg = document.getElementById('modal-bg');
  const modalBox = document.getElementById('modal-box');
  modalBg.style.display = 'flex';
  modalBox.innerHTML = `
    <div class="form-title">${t('createRoom')}</div>
    <form id="modal-create-room-form">
      <div class="form-group">
        <label class="form-label">${t('roomName')}</label>
        <input class="form-input" type="text" name="roomName" id="modal-room-name" maxlength="32" placeholder="${t('roomName')}" required />
      </div>
      <div class="form-group">
        <label class="form-label">${t('players')}</label>
        <select class="form-input" name="players" id="modal-players">
          ${[2,3,4,5,6].map(n => `<option value="${n}">${n}</option>`).join('')}
        </select>
      </div>
      <button class="form-btn" type="submit">${t('createRoom')}</button>
      <button class="form-btn" type="button" id="modal-cancel" style="background:#444;color:#fff;margin-top:8px;">áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ</button>
    </form>
  `;
  document.getElementById('modal-cancel').onclick = () => { modalBg.style.display = 'none'; };
  document.getElementById('modal-create-room-form').onsubmit = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const players = parseInt(fd.get('players'), 10);
    const roomName = fd.get('roomName')?.trim() || '';
    if (!roomName) {
      document.getElementById('modal-room-name').focus();
      return;
    }
    const token = localStorage.getItem('token');
    // áƒáƒ—áƒáƒ®áƒ˜áƒ¡ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ API-áƒ¨áƒ˜
    const res = await fetch('/api/rooms', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer '+token },
      body: JSON.stringify({ players, name: roomName })
    });
    if (res.ok) {
      const room = await res.json();
      // Save player count to localStorage for game page
      localStorage.setItem('great7-lobby', JSON.stringify({ n: players }));
      modalBg.style.display = 'none';
      window.location.href = `great7.html?room=${room.id}`;
    }
  };
}

// Auto-login if token exists
if (localStorage.getItem('token')) renderLobby();
else renderHome();

// Add missing translations for stats fields
if (!i18n.ka.stats) i18n.ka.stats = 'áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ';
if (!i18n.en.stats) i18n.en.stats = 'Stats';
if (!i18n.ru.stats) i18n.ru.stats = 'Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°';
if (!i18n.ka.wins) i18n.ka.wins = 'áƒ›áƒáƒ’áƒ”áƒ‘áƒ';
if (!i18n.en.wins) i18n.en.wins = 'Wins';
if (!i18n.ru.wins) i18n.ru.wins = 'ĞŸĞ¾Ğ±ĞµĞ´Ñ‹';
if (!i18n.ka.losses) i18n.ka.losses = 'áƒ¬áƒáƒ’áƒ”áƒ‘áƒ';
if (!i18n.en.losses) i18n.en.losses = 'Losses';
if (!i18n.ru.losses) i18n.ru.losses = 'ĞŸĞ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ';
if (!i18n.ka.gamesPlayed) i18n.ka.gamesPlayed = 'áƒ—áƒáƒ›áƒáƒ¨áƒ”áƒ‘áƒ˜';
if (!i18n.en.gamesPlayed) i18n.en.gamesPlayed = 'Games';
if (!i18n.ru.gamesPlayed) i18n.ru.gamesPlayed = 'Ğ˜Ğ³Ñ€Ñ‹';

// Dropdown language selector
function renderLangDropdown(parentId, currentLang, onSelect) {
  const langs = [
    { code: 'ka', label: 'áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜' },
    { code: 'en', label: 'English' },
    { code: 'ru', label: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹' }
  ];
  const currentLangObj = langs.find(l=>l.code===currentLang) || langs[0];
  let html = `<div class="lang-dropdown"><button class="lang-dropdown-btn" id="lang-dropdown-btn">${currentLangObj.label} â–¼</button><div class="lang-dropdown-list" id="lang-dropdown-list">`;
  for (const l of langs) {
    html += `<button class="lang-dropdown-item${l.code===currentLang?' active':''}" data-lang="${l.code}">${l.label}</button>`;
  }
  html += `</div></div>`;
  const parent = document.getElementById(parentId);
  if (!parent) return;
  parent.innerHTML = html;
  setTimeout(() => {
    const dropdownBtn = document.getElementById('lang-dropdown-btn');
    if (dropdownBtn) {
      dropdownBtn.onclick = function(e) {
        e.stopPropagation();
        const list = document.getElementById('lang-dropdown-list');
        if (list) list.classList.toggle('active');
      };
    }
    document.querySelectorAll('.lang-dropdown-item').forEach(btn => {
      btn.onclick = function(e) {
        e.stopPropagation();
        const lang = btn.getAttribute('data-lang');
        const list = document.getElementById('lang-dropdown-list');
        if (list) list.classList.remove('active');
        onSelect(lang);
      };
    });
  }, 0);
  document.body.onclick = function() {
    const list = document.getElementById('lang-dropdown-list');
    if (list) list.classList.remove('active');
  };
}

// Russian popup logic
function showRussianPopup() {
  let popup = document.getElementById('russian-popup-bg');
  if (!popup) {
    popup = document.createElement('div');
    popup.id = 'russian-popup-bg';
    popup.className = 'geoflag';
    popup.innerHTML = `<div id="russian-popup-box"><button id="russian-popup-close">Ã—</button><div id="russian-popup-title">ğŸ“Œ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ</div><div id="russian-popup-text">Ğ Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ°Ñ Ğ¤ĞµĞ´ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° Ğ¿Ñ€Ğ¾Ñ‚ÑĞ¶ĞµĞ½Ğ¸Ğ¸ Ğ´ĞµÑÑÑ‚Ğ¸Ğ»ĞµÑ‚Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ°Ğ³Ñ€ĞµÑÑĞ¸Ğ²Ğ½ÑƒÑ Ğ¸ ÑĞºÑĞ¿Ğ°Ğ½ÑĞ¸Ğ¾Ğ½Ğ¸ÑÑ‚ÑĞºÑƒÑ Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºÑƒ Ğ¿Ğ¾ Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ñ Ğº ÑĞ¾ÑĞµĞ´Ğ½Ğ¸Ğ¼ ÑÑ‚Ñ€Ğ°Ğ½Ğ°Ğ¼. ĞĞ´Ğ½Ğ¸Ğ¼ Ğ¸Ğ· ÑĞ°Ğ¼Ñ‹Ñ… ÑÑ€ĞºĞ¸Ñ… Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ¾Ğ² ÑÑ‚Ğ¾Ğ³Ğ¾ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ñ‚Ğ¾Ñ€Ğ¶ĞµĞ½Ğ¸Ğµ Ğ² Ğ“Ñ€ÑƒĞ·Ğ¸Ñ Ğ² 2008 Ğ³Ğ¾Ğ´Ñƒ Ğ¸ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ°Ñ Ğ¾ĞºĞºÑƒĞ¿Ğ°Ñ†Ğ¸Ñ Ğ¾ĞºĞ¾Ğ»Ğ¾ 20% ĞµÑ‘ Ñ‚ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸ â€” ĞĞ±Ñ…Ğ°Ğ·Ğ¸Ğ¸ Ğ¸ Ğ¦Ñ…Ğ¸Ğ½Ğ²Ğ°Ğ»ÑŒÑĞºĞ¾Ğ³Ğ¾ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½Ğ° (Ñ‚.Ğ½. Ğ®Ğ¶Ğ½Ğ¾Ğ¹ ĞÑĞµÑ‚Ğ¸Ğ¸).<br><br>ĞĞµÑĞ¼Ğ¾Ñ‚Ñ€Ñ Ğ½Ğ° Ğ¼ĞµĞ¶Ğ´ÑƒĞ½Ğ°Ñ€Ğ¾Ğ´Ğ½Ğ¾Ğµ Ğ¾ÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ğµ, Ğ Ğ¾ÑÑĞ¸Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµÑ‚ ÑƒĞ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¸ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½Ñ‹ Ğ¿Ğ¾Ğ´ ÑĞ²Ğ¾Ğ¸Ğ¼ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ĞµĞ¼, Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ Ğ²Ğ¼ĞµÑˆĞ¸Ğ²Ğ°ÑÑÑŒ Ğ²Ğ¾ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğµ Ğ´ĞµĞ»Ğ° Ğ“Ñ€ÑƒĞ·Ğ¸Ğ¸ â€” Ñ‡ĞµÑ€ĞµĞ· Ğ²Ğ¾ĞµĞ½Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ, Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ ÑĞµĞ¿Ğ°Ñ€Ğ°Ñ‚Ğ¸Ğ·Ğ¼Ğ° Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ ĞºĞ°Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸.<br><br>Ğ’ ÑƒÑĞ»Ğ¾Ğ²Ğ¸ÑÑ… Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ÑÑ‰ĞµĞ¹ÑÑ Ğ¾ĞºĞºÑƒĞ¿Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ğ½Ğ¸Ñ ÑĞ¾ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹ Ğ Ğ¾ÑÑĞ¸Ğ¸ ÑĞ²Ğ¾Ğ¸Ñ… Ğ¿Ñ€ĞµÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ÑƒÑÑĞºĞ¾Ğ³Ğ¾ ÑĞ·Ñ‹ĞºĞ° Ğ½Ğ° Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ²ĞµĞ±-ÑĞ°Ğ¹Ñ‚Ğµ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¾.<br><br>ğŸ“£ Ğ ÑƒÑÑĞºĞ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ ÑĞ°Ğ¹Ñ‚Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»Ğµ Ñ‚Ğ¾Ğ³Ğ¾, ĞºĞ°Ğº Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¾Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ğ¾ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°ĞµÑ‚ ÑĞ¾Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€ĞµÑÑ‚ÑƒĞ¿Ğ»ĞµĞ½Ğ¸Ñ, Ğ¿Ñ€Ğ¸Ğ½ĞµÑÑ‘Ñ‚ Ğ¸Ğ·Ğ²Ğ¸Ğ½ĞµĞ½Ğ¸Ñ Ğ½Ğ°Ñ€Ğ¾Ğ´Ñƒ Ğ“Ñ€ÑƒĞ·Ğ¸Ğ¸ Ğ¸ Ğ²ĞµÑ€Ğ½Ñ‘Ñ‚ Ğ¾ĞºĞºÑƒĞ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµÑ€Ñ€Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸.</div></div>`;
    document.body.appendChild(popup);
    document.getElementById('russian-popup-close').onclick = function() { popup.style.display = 'none'; };
  }
  popup.style.display = 'flex';
} 